<div class="profile-container">
  <div class="profile-content">
    <!-- R-0006: Profile Icon, User Information, Sign Out Button -->
    <div class="profile-header">
      <div class="profile-icon-section" 
           (mouseenter)="isEditingIcon ? null : startEditIcon()"
           [class.editing]="isEditingIcon">
        <img 
          [src]="user?.profileIcon || '/assets/default-avatar.svg'" 
          alt="Profile" 
          class="profile-icon">
        
        <!-- R-0014: Show edit option on hover -->
        <div class="icon-edit-overlay" *ngIf="!isEditingIcon">
          <span>Edit Icon</span>
        </div>

        <!-- R-0014, R-0015: Icon selector modal -->
        <div class="icon-selector" *ngIf="isEditingIcon">
          <h3>Choose Profile Icon</h3>
          <div class="icon-grid">
            <div *ngFor="let icon of availableIcons" 
                 class="icon-option"
                 [class.selected]="icon === selectedIcon"
                 (click)="selectedIcon = icon">
              <img [src]="icon" alt="Icon option">
            </div>
          </div>
          <div class="icon-actions">
            <button (click)="saveIconChange()" class="btn btn-primary">Save</button>
            <button (click)="cancelIconEdit()" class="btn btn-secondary">Cancel</button>
          </div>
        </div>
      </div>

      <div class="profile-info">
        <h1 class="profile-name">{{ user?.firstName || user?.username }}</h1>
        <p class="profile-username">{{ user?.username }}</p>
        <p class="profile-email">{{ user?.email }}</p>
      </div>

      <button (click)="authService.logout()" class="btn btn-signout">
        Sign Out
      </button>
    </div>

    <!-- R-0012, R-0013: Account Information Editor -->
    <div class="profile-section">
      <div class="section-header">
        <h2>Account Information</h2>
        <button *ngIf="!isEditingAccount" 
                (click)="startEditAccount()" 
                class="btn btn-edit">
          Change Info
        </button>
      </div>

      <div *ngIf="!isEditingAccount" class="info-display">
        <div class="info-item">
          <span class="info-label">First Name:</span>
          <span class="info-value">{{ user?.firstName || 'Not set' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Last Name:</span>
          <span class="info-value">{{ user?.lastName || 'Not set' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Email:</span>
          <span class="info-value">{{ user?.email }}</span>
        </div>
      </div>

      <div *ngIf="isEditingAccount" class="edit-form">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" [(ngModel)]="editFirstName" placeholder="First name">
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" [(ngModel)]="editLastName" placeholder="Last name">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" [(ngModel)]="editEmail" placeholder="Email">
        </div>
        <div class="form-actions">
          <button (click)="saveAccountChanges()" class="btn btn-primary">Save</button>
          <button (click)="cancelAccountEdit()" class="btn btn-secondary">Undo</button>
        </div>
      </div>
    </div>

    <!-- R-0006: Current Rosters Section -->
    <!-- R-0006: Current Rosters Section -->
    <div class="profile-section">
      <div class="section-header">
        <h2>My Rosters</h2>
      </div>

      <div class="rosters-grid" *ngIf="!isEditingRoster">
        <div *ngFor="let roster of rosters" class="roster-card">
          <h3>{{ getRosterName(roster) }}</h3>
          <p class="roster-format">{{ getLeagueFormat(roster) }}</p>
          <div class="roster-actions">
            <!-- R-0009: Update roster button -->
            <button (click)="startEditRoster(roster)" class="btn btn-edit-roster">
              Edit Roster
            </button>
            <button (click)="deleteRoster(roster)" class="btn btn-delete">
              Delete
            </button>
          </div>
        </div>

        <div class="roster-card add-roster" (click)="openCreateRoster()" *ngIf="rosters.length < 5">
          <span class="add-icon">+</span>
          <p>Add New Roster</p>
          <p class="roster-limit">{{ rosters.length }}/5 rosters</p>
        </div>
      </div>

      <!-- R-0010, R-0011: Edit Roster Mode -->
      <div class="roster-editor" *ngIf="isEditingRoster && selectedRoster">
        <h3>Editing: {{ getRosterName(selectedRoster) }}</h3>
        
        <div class="roster-slots">
          <div *ngFor="let slotConfig of rosterStructure" class="roster-slot">
            <div class="slot-header">
              <span class="slot-label">{{ slotConfig.label }}</span>
              <span class="slot-position">({{ slotConfig.position }})</span>
            </div>
            
            <div class="slot-content">
              <ng-container *ngIf="getPlayerInSlot(slotConfig.slot)?.player_id; else emptySlot">
                <div class="player-in-slot">
                  <div class="player-details">
                    <span class="player-name">{{ getPlayerInSlot(slotConfig.slot)?.player_name }}</span>
                    <span class="player-team">{{ getPlayerInSlot(slotConfig.slot)?.team_name }} - {{ getPlayerInSlot(slotConfig.slot)?.position }}</span>
                  </div>
                  <button (click)="removePlayerFromSelectedSlot(slotConfig.slot)" class="btn-remove">✕</button>
                </div>
              </ng-container>
              
              <ng-template #emptySlot>
                <button (click)="selectSlot(slotConfig.slot)" class="btn-add-player">
                  + Add Player
                </button>
              </ng-template>
            </div>
          </div>
        </div>

        <!-- Player Search (shown when a slot is selected) -->
        <div class="player-search-modal" *ngIf="selectedSlot">
          <div class="modal-overlay" (click)="selectedSlot = null"></div>
          <div class="modal-content">
            <div class="modal-header">
              <h4>Add Player to {{ getSlotConfig(selectedSlot)?.label }}</h4>
              <button (click)="selectedSlot = null" class="btn-close">✕</button>
            </div>

            <div class="search-wrapper">
              <input 
                type="text" 
                [(ngModel)]="playerSearchQuery"
                (input)="searchPlayers()"
                placeholder="Search players..."
                class="search-input"
                autocomplete="off">
              <span *ngIf="isSearching" class="searching">Searching...</span>
              
              <!-- Search results directly inside wrapper -->
              <div class="search-results-dropdown" *ngIf="getFilteredSearchResults().length > 0">
                <div *ngFor="let player of getFilteredSearchResults()" 
                     class="search-result-item"
                     (click)="addPlayerToSelectedSlot(player)">
                  <div class="player-details">
                    <span class="player-name">{{ getPlayerName(player) }}</span>
                    <span class="player-position">{{ player.position }} - {{ getTeamName(player) }}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="no-results" *ngIf="playerSearchQuery.length >= 2 && getFilteredSearchResults().length === 0 && !isSearching">
              <p>No {{ getSlotConfig(selectedSlot)?.position }} players found</p>
            </div>
          </div>
        </div>

        <!-- R-0011: Save button -->
        <div class="roster-editor-actions">
          <button (click)="saveRosterChanges()" class="btn btn-primary">
            Done Editing
          </button>
        </div>
      </div>
    </div>

    <!-- Create Roster Modal -->
    <div class="create-roster-modal" *ngIf="isCreatingRoster">
      <div class="modal-overlay" (click)="closeCreateRoster()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Create New Roster</h3>
          <button (click)="closeCreateRoster()" class="btn-close">✕</button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label for="rosterName">Roster Name</label>
            <input 
              type="text" 
              id="rosterName"
              [(ngModel)]="newRosterName"
              placeholder="Enter roster name"
              class="input-field">
          </div>

          <div class="form-group">
            <label for="leagueFormat">League Format</label>
            <select id="leagueFormat" [(ngModel)]="newRosterFormat" class="input-field">
              <option value="Standard">Standard</option>
              <option value="Half-PPR">Half-PPR</option>
              <option value="PPR">PPR</option>
            </select>
          </div>
        </div>

        <div class="modal-actions">
          <button (click)="createRoster()" class="btn btn-primary">Create Roster</button>
          <button (click)="closeCreateRoster()" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>